name: iOS Build Check

on:
  push:
    branches:
      - dev
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:
  build-check:
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test
        continue-on-error: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          pod install

      # Build check: Verify that the app builds successfully (without code signing)
      # Note: Actual archive and upload are done manually via Xcode
      - name: Build iOS app
        run: |
          flutter build ios --release --no-codesign

      # Send Slack notification
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set. Skipping Slack notification."
            exit 0
          fi
          
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="✅ Success"
            COLOR="good"
          elif [ "${{ job.status }}" == "failure" ]; then
            STATUS="❌ Failure"
            COLOR="danger"
          else
            STATUS="⚠️ Cancelled"
            COLOR="warning"
          fi
          
          # Get branch name
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
            COMMIT_MESSAGE="${{ github.event.pull_request.title }}"
            COMMIT_AUTHOR="${{ github.event.pull_request.user.login }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
            COMMIT_MESSAGE="${{ github.event.head_commit.message || github.event.commits[0].message || 'No commit message' }}"
            COMMIT_AUTHOR="${{ github.event.head_commit.author.name || github.actor }}"
          fi
          
          WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "iOS Build Check - ${STATUS}",
            "attachments": [
              {
                "color": "${COLOR}",
                "fields": [
                  {
                    "title": "Branch",
                    "value": "${BRANCH_NAME}",
                    "short": true
                  },
                  {
                    "title": "Event",
                    "value": "${{ github.event_name }}",
                    "short": true
                  },
                  {
                    "title": "Author",
                    "value": "${COMMIT_AUTHOR}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "<${WORKFLOW_RUN_URL}|View Run>",
                    "short": true
                  },
                  {
                    "title": "Message",
                    "value": "${COMMIT_MESSAGE}",
                    "short": false
                  }
                ],
                "footer": "GitHub Actions",
                "ts": $(date +%s)
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "${PAYLOAD}" \
            "${SLACK_WEBHOOK_URL}" || echo "Failed to send Slack notification"
