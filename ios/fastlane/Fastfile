# Fastfile for iOS app distribution
# Documentation: https://docs.fastlane.tools/actions/

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Match: Get certificates and provisioning profiles
    # readonly: true for CI/CD environments to prevent creating new certificates
    match_options = {
      type: "appstore",
      readonly: ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true",
      app_identifier: "com.leo.omuee"
    }
    # Use App Store Connect API Key in CI environment (only if path is set and file exists)
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    if api_key_path && !api_key_path.to_s.strip.empty? && File.exist?(api_key_path.to_s)
      match_options[:api_key_path] = api_key_path
    end
    match(match_options)
    
    # Get version from pubspec.yaml
    version_line = sh("cd ../.. && grep '^version:' pubspec.yaml | head -1", log: false).strip
    build_number = version_line.split('+').last.to_i
    
    # Format build number as 3-digit zero-padded (001, 002, etc.)
    formatted_build_number = sprintf("%03d", build_number)
    
    # Flutter build with formatted build number
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    
    # Pre-build CocoaPods to avoid hang during flutter build
    UI.message("Installing CocoaPods dependencies...")
    sh("cd ../.. && cd ios && pod install")
    
    # Build iOS app without codesigning first (to avoid xcodebuild -showBuildSettings hang)
    UI.message("Building iOS app...")
    sh("cd ../.. && flutter build ios --release --build-number=#{formatted_build_number} --no-codesign")
    
    # Archive and export using xcodebuild directly
    UI.message("Archiving app...")
    archive_path = "../build/ios/Runner.xcarchive"
    sh("cd ../.. && cd ios && xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -archivePath #{archive_path} archive CODE_SIGN_IDENTITY=\"Apple Distribution\" CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER=\"69c9c1f5-a031-40a6-91c1-6eca9a28c625\"")
    
    # Export IPA
    UI.message("Exporting IPA...")
    export_options_plist_path = File.join(Dir.pwd, "..", "exportOptions.plist")
    export_options_content = <<~XML
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>W92T9A5F6P</string>
          <key>uploadBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <true/>
          <key>compileBitcode</key>
          <false/>
      </dict>
      </plist>
    XML
    File.write(export_options_plist_path, export_options_content)
    sh("cd ../.. && cd ios && xcodebuild -exportArchive -archivePath #{archive_path} -exportPath ../build/ios/ipa -exportOptionsPlist exportOptions.plist")
    sh("cd ../.. && mv build/ios/ipa/Runner.ipa build/ios/ipa/omulet_app.ipa 2>/dev/null || true")
    
    # Upload to TestFlight
    upload_to_testflight(
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
      ipa: "../../build/ios/ipa/omulet_app.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false
    )
  end

  desc "Build and upload to App Store"
  lane :release do
    # Match: Get certificates and provisioning profiles
    match_options = {
      type: "appstore",
      readonly: ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true",
      app_identifier: "com.leo.omuee"
    }
    # Use App Store Connect API Key in CI environment (only if path is set and file exists)
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    if api_key_path && !api_key_path.to_s.strip.empty? && File.exist?(api_key_path.to_s)
      match_options[:api_key_path] = api_key_path
    end
    match(match_options)
    
    # Get version from pubspec.yaml
    version_line = sh("cd ../.. && grep '^version:' pubspec.yaml | head -1", log: false).strip
    build_number = version_line.split('+').last.to_i
    
    # Format build number as 3-digit zero-padded (001, 002, etc.)
    formatted_build_number = sprintf("%03d", build_number)
    
    # Flutter build with formatted build number
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    
    # Pre-build CocoaPods to avoid hang during flutter build
    UI.message("Installing CocoaPods dependencies...")
    sh("cd ../.. && cd ios && pod install")
    
    # Build iOS app without codesigning first (to avoid xcodebuild -showBuildSettings hang)
    UI.message("Building iOS app...")
    sh("cd ../.. && flutter build ios --release --build-number=#{formatted_build_number} --no-codesign")
    
    # Archive and export using xcodebuild directly
    UI.message("Archiving app...")
    archive_path = "../build/ios/Runner.xcarchive"
    sh("cd ../.. && cd ios && xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -archivePath #{archive_path} archive CODE_SIGN_IDENTITY=\"Apple Distribution\" CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER=\"69c9c1f5-a031-40a6-91c1-6eca9a28c625\"")
    
    # Export IPA
    UI.message("Exporting IPA...")
    export_options_plist_path = File.join(Dir.pwd, "..", "exportOptions.plist")
    export_options_content = <<~XML
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>W92T9A5F6P</string>
          <key>uploadBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <true/>
          <key>compileBitcode</key>
          <false/>
      </dict>
      </plist>
    XML
    File.write(export_options_plist_path, export_options_content)
    sh("cd ../.. && cd ios && xcodebuild -exportArchive -archivePath #{archive_path} -exportPath ../build/ios/ipa -exportOptionsPlist exportOptions.plist")
    sh("cd ../.. && mv build/ios/ipa/Runner.ipa build/ios/ipa/omulet_app.ipa 2>/dev/null || true")
    
    # Upload to App Store
    upload_to_app_store(
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
      ipa: "../../build/ios/ipa/omulet_app.ipa",
      skip_metadata: false,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Build iOS app only (no upload)"
  lane :build do
    # Match: Get certificates and provisioning profiles
    match_options = {
      type: "appstore",
      readonly: ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true",
      app_identifier: "com.leo.omuee"
    }
    # Use App Store Connect API Key in CI environment (only if path is set and file exists)
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    if api_key_path && !api_key_path.to_s.strip.empty? && File.exist?(api_key_path.to_s)
      match_options[:api_key_path] = api_key_path
    end
    match(match_options)
    
    # Get version from pubspec.yaml
    version_line = sh("cd ../.. && grep '^version:' pubspec.yaml | head -1", log: false).strip
    build_number = version_line.split('+').last.to_i
    
    # Format build number as 3-digit zero-padded (001, 002, etc.)
    formatted_build_number = sprintf("%03d", build_number)
    
    # Flutter build with formatted build number
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    
    # Pre-build CocoaPods to avoid hang during flutter build
    UI.message("Installing CocoaPods dependencies...")
    sh("cd ../.. && cd ios && pod install")
    
    # Build iOS app without codesigning first (to avoid xcodebuild -showBuildSettings hang)
    UI.message("Building iOS app...")
    sh("cd ../.. && flutter build ios --release --build-number=#{formatted_build_number} --no-codesign")
    
    # Archive and export using xcodebuild directly
    UI.message("Archiving app...")
    archive_path = "../build/ios/Runner.xcarchive"
    sh("cd ../.. && cd ios && xcodebuild -workspace Runner.xcworkspace -scheme Runner -configuration Release -archivePath #{archive_path} archive CODE_SIGN_IDENTITY=\"Apple Distribution\" CODE_SIGN_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER=\"69c9c1f5-a031-40a6-91c1-6eca9a28c625\"")
    
    # Export IPA
    UI.message("Exporting IPA...")
    export_options_plist_path = File.join(Dir.pwd, "..", "exportOptions.plist")
    export_options_content = <<~XML
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>W92T9A5F6P</string>
          <key>uploadBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <true/>
          <key>compileBitcode</key>
          <false/>
      </dict>
      </plist>
    XML
    File.write(export_options_plist_path, export_options_content)
    sh("cd ../.. && cd ios && xcodebuild -exportArchive -archivePath #{archive_path} -exportPath ../build/ios/ipa -exportOptionsPlist exportOptions.plist")
    sh("cd ../.. && mv build/ios/ipa/Runner.ipa build/ios/ipa/omulet_app.ipa 2>/dev/null || true")
  end
end
