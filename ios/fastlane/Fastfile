# Fastfile for iOS app distribution
# Documentation: https://docs.fastlane.tools/actions/

default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Match: Get certificates and provisioning profiles
    # readonly: true for CI/CD environments to prevent creating new certificates
    match_options = {
      type: "appstore",
      readonly: ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true",
      app_identifier: "com.leo.omuee"
    }
    # Use App Store Connect API Key in CI environment (only if path is set and file exists)
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    if api_key_path && !api_key_path.to_s.strip.empty? && File.exist?(api_key_path.to_s)
      match_options[:api_key_path] = api_key_path
    end
    match(match_options)
    
    # Get version from pubspec.yaml
    version_line = sh("cd ../.. && grep '^version:' pubspec.yaml | head -1", log: false).strip
    build_number = version_line.split('+').last.to_i
    
    # Format build number as 3-digit zero-padded (001, 002, etc.)
    formatted_build_number = sprintf("%03d", build_number)
    
    # Flutter build with formatted build number
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    
    # Pre-build CocoaPods to avoid hang during flutter build
    UI.message("Installing CocoaPods dependencies...")
    sh("cd ios && pod install --repo-update")
    
    # Build with verbose logging to identify hang issues
    build_log_path = "/tmp/flutter_build_#{Time.now.to_i}.log"
    UI.message("Building with verbose logging. Log will be saved to: #{build_log_path}")
    begin
      sh("cd ../.. && flutter build ipa --release --build-number=#{formatted_build_number} --export-method app-store --verbose 2>&1 | tee #{build_log_path}")
    rescue => ex
      UI.error("Build failed. Showing last 200 lines of build log:")
      sh("tail -200 #{build_log_path} || true")
      raise ex
    end
    
    # Upload to TestFlight
    upload_to_testflight(
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
      ipa: "../../build/ios/ipa/omulet_app.ipa",
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false
    )
  end

  desc "Build and upload to App Store"
  lane :release do
    # Match: Get certificates and provisioning profiles
    match_options = {
      type: "appstore",
      readonly: ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true",
      app_identifier: "com.leo.omuee"
    }
    # Use App Store Connect API Key in CI environment (only if path is set and file exists)
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    if api_key_path && !api_key_path.to_s.strip.empty? && File.exist?(api_key_path.to_s)
      match_options[:api_key_path] = api_key_path
    end
    match(match_options)
    
    # Get version from pubspec.yaml
    version_line = sh("cd ../.. && grep '^version:' pubspec.yaml | head -1", log: false).strip
    build_number = version_line.split('+').last.to_i
    
    # Format build number as 3-digit zero-padded (001, 002, etc.)
    formatted_build_number = sprintf("%03d", build_number)
    
    # Flutter build with formatted build number
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    
    # Pre-build CocoaPods to avoid hang during flutter build
    UI.message("Installing CocoaPods dependencies...")
    sh("cd ios && pod install --repo-update")
    
    # Build with verbose logging to identify hang issues
    build_log_path = "/tmp/flutter_build_#{Time.now.to_i}.log"
    UI.message("Building with verbose logging. Log will be saved to: #{build_log_path}")
    begin
      sh("cd ../.. && flutter build ipa --release --build-number=#{formatted_build_number} --export-method app-store --verbose 2>&1 | tee #{build_log_path}")
    rescue => ex
      UI.error("Build failed. Showing last 200 lines of build log:")
      sh("tail -200 #{build_log_path} || true")
      raise ex
    end
    
    # Upload to App Store
    upload_to_app_store(
      api_key_path: ENV["APP_STORE_CONNECT_API_KEY_PATH"],
      ipa: "../../build/ios/ipa/omulet_app.ipa",
      skip_metadata: false,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false
    )
  end

  desc "Build iOS app only (no upload)"
  lane :build do
    # Match: Get certificates and provisioning profiles
    match_options = {
      type: "appstore",
      readonly: ENV["CI"] == "true" || ENV["GITHUB_ACTIONS"] == "true",
      app_identifier: "com.leo.omuee"
    }
    # Use App Store Connect API Key in CI environment (only if path is set and file exists)
    api_key_path = ENV["APP_STORE_CONNECT_API_KEY_PATH"]
    if api_key_path && !api_key_path.to_s.strip.empty? && File.exist?(api_key_path.to_s)
      match_options[:api_key_path] = api_key_path
    end
    match(match_options)
    
    # Get version from pubspec.yaml
    version_line = sh("cd ../.. && grep '^version:' pubspec.yaml | head -1", log: false).strip
    build_number = version_line.split('+').last.to_i
    
    # Format build number as 3-digit zero-padded (001, 002, etc.)
    formatted_build_number = sprintf("%03d", build_number)
    
    # Flutter build with formatted build number
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    
    # Pre-build CocoaPods to avoid hang during flutter build
    UI.message("Installing CocoaPods dependencies...")
    sh("cd ios && pod install --repo-update")
    
    # Build with verbose logging to identify hang issues
    build_log_path = "/tmp/flutter_build_#{Time.now.to_i}.log"
    UI.message("Building with verbose logging. Log will be saved to: #{build_log_path}")
    begin
      sh("cd ../.. && flutter build ipa --release --build-number=#{formatted_build_number} --export-method app-store --verbose 2>&1 | tee #{build_log_path}")
    rescue => ex
      UI.error("Build failed. Showing last 200 lines of build log:")
      sh("tail -200 #{build_log_path} || true")
      raise ex
    end
  end
end
